# Rennie — rennie.renthero.com
# Cloudflare → nginx → auth service / gateway / sync

# Cloudflare IP ranges (restrict direct access)
# https://www.cloudflare.com/ips/
geo $is_cloudflare {
    default          0;
    173.245.48.0/20  1;
    103.21.244.0/22  1;
    103.22.200.0/22  1;
    103.31.4.0/22    1;
    141.101.64.0/18  1;
    108.162.192.0/18 1;
    190.93.240.0/20  1;
    188.114.96.0/20  1;
    197.234.240.0/22 1;
    198.41.128.0/17  1;
    162.158.0.0/15   1;
    104.16.0.0/13    1;
    104.24.0.0/14    1;
    172.64.0.0/13    1;
    131.0.72.0/22    1;
    # Also allow localhost for testing
    127.0.0.1/32     1;
}

server {
    listen 80;
    server_name rennie.renthero.com;

    # Block non-Cloudflare traffic
    if ($is_cloudflare = 0) {
        return 403;
    }

    # Trust Cloudflare's real IP header
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 131.0.72.0/22;
    real_ip_header CF-Connecting-IP;

    # ─── Auth endpoints (no token required) ─────────────────────────
    location /auth/ {
        proxy_pass http://127.0.0.1:18791;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ─── Internal auth validation subrequest ────────────────────────
    location = /internal/auth-check {
        internal;
        proxy_pass http://127.0.0.1:18791/auth/validate;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header Authorization $http_authorization;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ─── Gateway API (token required) ───────────────────────────────
    location /api/ {
        auth_request /internal/auth-check;
        auth_request_set $auth_user $upstream_http_x_auth_user;

        # Strip /api/ prefix — gateway expects /v1/...
        rewrite ^/api/(.*) /$1 break;

        proxy_pass http://127.0.0.1:18789;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Auth-User $auth_user;
        # Pass the gateway's own token so it accepts the request
        proxy_set_header Authorization "Bearer REDACTED_TOKEN";

        # SSE support for streaming
        proxy_http_version 1.1;
        proxy_set_header Connection '';
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
    }

    # ─── Sync server (token required) ───────────────────────────────
    location /sync {
        auth_request /internal/auth-check;
        auth_request_set $auth_user $upstream_http_x_auth_user;

        # Backend expects /sync/* paths — proxy exact URI
        proxy_pass http://127.0.0.1:18790$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Auth-User $auth_user;
        # Pass the gateway token for sync server auth
        proxy_set_header Authorization "Bearer REDACTED_TOKEN";
    }

    # ─── Root ───────────────────────────────────────────────────────
    location / {
        return 200 '{"service":"rennie","status":"ok"}';
        add_header Content-Type application/json;
    }

    # ─── Logging ────────────────────────────────────────────────────
    access_log /var/log/nginx/rennie-access.log;
    error_log /var/log/nginx/rennie-error.log;
}
