# Rennie — rennie.renthero.com
# Cloudflare → nginx → auth service / gateway / sync

# Validate Cloudflare traffic via CF-Connecting-IP header
# (only Cloudflare adds this — direct connections won't have it)
map $http_cf_connecting_ip $is_cloudflare {
    default 1;
    ""      0;
}

server {
    listen 80;
    listen 443 ssl;
    server_name rennie.renthero.com;

    # SSL for Cloudflare Full mode
    ssl_certificate /etc/nginx/ssl/rennie.crt;
    ssl_certificate_key /etc/nginx/ssl/rennie.key;
    ssl_protocols TLSv1.2 TLSv1.3;

    # Block non-Cloudflare traffic (no CF-Connecting-IP = direct hit)
    if ($is_cloudflare = 0) {
        return 403;
    }

    # Trust Cloudflare's real IP header
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 131.0.72.0/22;
    real_ip_header CF-Connecting-IP;

    # ─── Auth endpoints (no token required) ─────────────────────────
    location /auth/ {
        proxy_pass http://127.0.0.1:18791;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ─── Internal auth validation subrequest ────────────────────────
    location = /internal/auth-check {
        internal;
        proxy_pass http://127.0.0.1:18791/auth/validate;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header Authorization $http_authorization;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ─── Gateway API (token required) ───────────────────────────────
    location /api/ {
        auth_request /internal/auth-check;
        auth_request_set $auth_user $upstream_http_x_auth_user;

        # Strip /api/ prefix — gateway expects /v1/...
        rewrite ^/api/(.*) /$1 break;

        proxy_pass http://127.0.0.1:18789;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Auth-User $auth_user;
        # Pass the gateway's own token so it accepts the request
        # Token loaded from /etc/nginx/rennie-gateway-token.conf (include)
        # Format: set $gateway_token "your-token-here";
        include /etc/nginx/rennie-gateway-token.conf;
        proxy_set_header Authorization "Bearer $gateway_token";

        # SSE support for streaming
        proxy_http_version 1.1;
        proxy_set_header Connection '';
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
    }

    # ─── Sync server (token required) ───────────────────────────────
    location /sync {
        auth_request /internal/auth-check;
        auth_request_set $auth_user $upstream_http_x_auth_user;

        # Backend expects /sync/* paths — proxy exact URI
        proxy_pass http://127.0.0.1:18790$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Auth-User $auth_user;
        # Pass the gateway token for sync server auth
        include /etc/nginx/rennie-gateway-token.conf;
        proxy_set_header Authorization "Bearer $gateway_token";
    }

    # ─── Root / Landing Page ────────────────────────────────────────
    location = / {
        proxy_pass http://127.0.0.1:18791;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ─── Logging ────────────────────────────────────────────────────
    access_log /var/log/nginx/rennie-access.log;
    error_log /var/log/nginx/rennie-error.log;
}
